<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI æ™ºèƒ½æ‰‹ç›¸ & é¢ç›¸å¤§å¸ˆ | AI Destiny Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #1a0b2e;
            color: #e2d8f0;
            background-image: radial-gradient(circle at 50% 0%, #2d1b4e 0%, #1a0b2e 70%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .mystic-border { border: 1px solid rgba(216, 180, 254, 0.3); box-shadow: 0 0 15px rgba(168, 85, 247, 0.1); }
        .upload-box { transition: all 0.3s ease; background: rgba(255, 255, 255, 0.03); border: 2px dashed rgba(168, 85, 247, 0.4); }
        .upload-box:hover { background: rgba(255, 255, 255, 0.08); border-color: #d8b4fe; transform: translateY(-2px); }
        .upload-box.has-image { border-style: solid; border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .glow-btn { background: linear-gradient(135deg, #7c3aed 0%, #db2777 100%); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .glow-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(219, 39, 119, 0.5); }
        .glow-btn:disabled { background: #4b5563; cursor: not-allowed; transform: none; box-shadow: none; }
        .bmc-btn { background-color: #FFDD00; color: #000000; font-weight: bold; transition: transform 0.2s; border: 2px solid #e6c800; }
        .bmc-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 221, 0, 0.3); }
        .tab-btn { transition: all 0.3s ease; border-bottom: 2px solid transparent; opacity: 0.6; }
        .tab-btn.active { opacity: 1; border-bottom-color: #d8b4fe; color: #fff; background: rgba(255,255,255,0.05); }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #d8b4fe; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.8; color: #e2d8f0; }
        .markdown-body strong { color: #f0abfc; }
        .crystal-ball { width: 100px; height: 100px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(216,180,254,0.4), rgba(124,58,237,0.8)); border-radius: 50%; box-shadow: 0 0 30px #a855f7, inset 0 0 20px rgba(255,255,255,0.5); margin: 0 auto; position: relative; animation: float 3s ease-in-out infinite; }
        .face-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 70%; border: 2px dashed rgba(255,255,255,0.2); border-radius: 50% 50% 60% 60%; pointer-events: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); box-shadow: 0 0 30px #a855f7; } 50% { transform: translateY(-10px); box-shadow: 0 20px 40px #a855f7; } }
        img { -webkit-touch-callout: none; -webkit-user-select: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <div class="inline-block p-2 rounded-full border border-purple-500/30 mb-4 bg-purple-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#d8b4fe" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
            </div>
            <h1 class="text-3xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-300 to-pink-300 mb-2">AI å‘½ç†å¤§å¸ˆ</h1>
            <p class="text-purple-300/60 text-sm md:text-lg">AI Destiny Master Â· æ‰‹ç›¸ & é¢ç›¸</p>
        </div>

        <div class="flex justify-center mb-8">
            <div class="bg-[#130722] p-1 rounded-xl border border-purple-500/30 flex">
                <button onclick="switchMode('hand')" id="tabHand" class="tab-btn active px-6 py-2 rounded-lg text-purple-200 font-medium flex items-center gap-2"><span>âœ‹</span> æ‰‹ç›¸è§£è¯»</button>
                <button onclick="switchMode('face')" id="tabFace" class="tab-btn px-6 py-2 rounded-lg text-purple-200 font-medium flex items-center gap-2"><span>ğŸ‘¤</span> é¢ç›¸è§£è¯»</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div id="handSection" class="space-y-6 transition-opacity duration-300">
                    <div class="relative p-4 bg-[#130722] rounded-xl mystic-border text-center">
                        <h3 class="text-lg font-semibold mb-2 text-purple-200">å·¦æ‰‹ (å…ˆå¤©)</h3>
                        <div class="upload-box rounded-lg p-4 h-40 flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('fileLeft').click()" id="dropZoneLeft">
                            <input type="file" id="fileLeft" class="hidden" accept="image/*" onchange="handleFileSelect(this, 'previewLeft', 'dropZoneLeft', 'leftHand')">
                            <div id="previewLeft" class="w-full h-full flex flex-col items-center justify-center">
                                <svg class="w-8 h-8 text-purple-400/50 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span class="text-xs text-purple-300/70">ç‚¹å‡»ä¸Šä¼ </span>
                            </div>
                            <img id="imgLeft" class="hidden w-full h-full object-cover rounded-md">
                        </div>
                    </div>
                    <div class="relative p-4 bg-[#130722] rounded-xl mystic-border text-center">
                        <h3 class="text-lg font-semibold mb-2 text-purple-200">å³æ‰‹ (åå¤©)</h3>
                        <div class="upload-box rounded-lg p-4 h-40 flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('fileRight').click()" id="dropZoneRight">
                            <input type="file" id="fileRight" class="hidden" accept="image/*" onchange="handleFileSelect(this, 'previewRight', 'dropZoneRight', 'rightHand')">
                            <div id="previewRight" class="w-full h-full flex flex-col items-center justify-center">
                                <svg class="w-8 h-8 text-purple-400/50 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span class="text-xs text-purple-300/70">ç‚¹å‡»ä¸Šä¼ </span>
                            </div>
                            <img id="imgRight" class="hidden w-full h-full object-cover rounded-md">
                        </div>
                    </div>
                </div>

                <div id="faceSection" class="hidden transition-opacity duration-300">
                    <div class="relative group h-[400px]">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl opacity-30 group-hover:opacity-75 transition duration-500 blur"></div>
                        <div class="relative h-full p-6 bg-[#130722] rounded-xl mystic-border text-center flex flex-col">
                            <h3 class="text-xl font-semibold mb-4 text-purple-200">é¢ç›¸æ‰«æ</h3>
                            <p class="text-xs text-gray-400 mb-4">è¯·ç¡®ä¿äº”å®˜æ¸…æ™°ï¼Œæ— é®æŒ¡</p>
                            <div class="upload-box rounded-lg flex-1 relative overflow-hidden flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('fileFace').click()" id="dropZoneFace">
                                <input type="file" id="fileFace" class="hidden" accept="image/*" onchange="handleFileSelect(this, 'previewFace', 'dropZoneFace', 'face')">
                                <div class="face-guide" id="faceGuide"></div>
                                <div id="previewFace" class="w-full h-full flex flex-col items-center justify-center z-10">
                                    <svg class="w-16 h-16 text-purple-400/50 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <span class="text-sm text-purple-300/70">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ è‡ªæ‹</span>
                                </div>
                                <img id="imgFace" class="hidden w-full h-full object-cover z-20" alt="Face Preview">
                            </div>
                        </div>
                    </div>
                </div>

                <button id="analyzeBtn" onclick="analyzeDestiny()" class="glow-btn w-full py-4 rounded-xl text-white font-bold text-lg tracking-widest flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnIcon">ğŸ”®</span> <span id="btnText">å¼€å§‹è§£è¯»å‘½è¿</span>
                </button>
            </div>

            <div class="lg:col-span-2">
                <div class="h-full min-h-[500px] bg-[#130722]/80 rounded-2xl border border-purple-500/20 p-8 relative overflow-hidden flex flex-col">
                    <div id="resultPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-purple-300/40 p-8 text-center">
                        <div class="text-6xl mb-4 opacity-20">â˜¯ï¸</div>
                        <p class="text-xl" id="placeholderText">è¯·ä¸Šä¼ ç…§ç‰‡<br>AI å¤§å¸ˆå°†ä¸ºæ‚¨æ­å¼€å‘½è¿è¿·é›¾</p>
                    </div>
                    <div id="loadingState" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-[#130722]/90 backdrop-blur-sm">
                        <div class="crystal-ball mb-8"></div>
                        <h3 class="text-2xl text-purple-100 font-bold mb-2">å¤§å¸ˆé€šçµä¸­...</h3>
                        <p class="text-purple-300/70 animate-pulse" id="loadingText">æ­£åœ¨æ¨æ¼”å¤©æœº...</p>
                    </div>
                    <div id="resultContent" class="hidden relative z-10 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-6 border-b border-purple-500/30 pb-4 flex-shrink-0">
                            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-pink-200" id="resultTitle">å¤§å¸ˆè§£è¯»æŠ¥å‘Š</h2>
                            <button onclick="resetApp()" class="text-sm text-purple-400 hover:text-white transition-colors">é‡æ–°æµ‹è¯•</button>
                        </div>
                        <div id="markdownOutput" class="markdown-body text-purple-100 leading-relaxed mb-6"></div>
                        
                        <!-- Simple Donation Button -->
                        <div class="pt-4 border-t border-purple-500/20 text-center flex-shrink-0 mt-4">
                            <a href="https://buymeacoffee.com/hhlove" target="_blank" class="bmc-btn inline-flex items-center gap-2 px-6 py-3 rounded-full text-sm md:text-base mx-auto">
                                <span>â˜•</span>
                                <span>è§‰å¾—å‡†ï¼Ÿè¯·å¤§å¸ˆå–æ¯å’–å•¡ï¼Œç§¯ç´¯åŠŸå¾· ğŸ™</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-12 text-purple-500/40 text-sm"><p>AI ç”Ÿæˆç»“æœä»…ä¾›å¨±ä¹å‚è€ƒ | Powered by Google Gemini 1.5 Vision</p></div>
    </div>

    <script>
        // State - MimeType added
        let activeMode = 'hand';
        let leftHandBase64 = null, leftHandMime = 'image/jpeg';
        let rightHandBase64 = null, rightHandMime = 'image/jpeg';
        let faceBase64 = null, faceMime = 'image/jpeg';

        // âš ï¸âš ï¸âš ï¸ å¡«å…¥ä½ çš„ API Key (ç›´è¿ Google) âš ï¸âš ï¸âš ï¸
        // const apiKey = ""; 

        function switchMode(mode) {
            activeMode = mode;
            document.getElementById('tabHand').classList.toggle('active', mode === 'hand');
            document.getElementById('tabFace').classList.toggle('active', mode === 'face');
            document.getElementById('handSection').classList.toggle('hidden', mode !== 'hand');
            document.getElementById('faceSection').classList.toggle('hidden', mode !== 'face');
            document.getElementById('placeholderText').innerHTML = mode === 'hand' ? "è¯·ä¸Šä¼ æ‰‹ç›¸ç…§ç‰‡<br>å¤§å¸ˆä¸ºæ‚¨çœ‹æŒä¸­ä¹¾å¤" : "è¯·ä¸Šä¼ é¢ç›¸è‡ªæ‹<br>å¤§å¸ˆä¸ºæ‚¨çœ‹ä¸‰åº­äº”çœ¼";
        }

        // ğŸš€ å‹ç¼©å›¾ç‰‡ (800px, 0.6 quality) è§£å†³ 413 é—®é¢˜
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 800; // è¿›ä¸€æ­¥ç¼©å°ä»¥é˜²ä¸‡ä¸€

                        if (width > height) {
                            if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å¼ºåŠ›å‹ç¼©
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        async function handleFileSelect(input, previewId, zoneId, type) {
            const file = input.files[0];
            if (!file) return;

            // æ‰§è¡Œå‹ç¼©
            const compressedBase64Full = await compressImage(file);
            
            document.getElementById(previewId).classList.add('hidden');
            const imgEl = document.getElementById(zoneId).querySelector('img');
            imgEl.classList.remove('hidden');
            imgEl.src = compressedBase64Full;
            document.getElementById(zoneId).classList.add('has-image');

            if (type === 'face') document.getElementById('faceGuide').style.display = 'none';

            const base64Data = compressedBase64Full.split(',')[1];
            const mimeType = 'image/jpeg'; // å‹ç¼©åä¸€å®šæ˜¯ jpeg

            if (type === 'leftHand') { leftHandBase64 = base64Data; leftHandMime = mimeType; }
            if (type === 'rightHand') { rightHandBase64 = base64Data; rightHandMime = mimeType; }
            if (type === 'face') { faceBase64 = base64Data; faceMime = mimeType; }
        }

        function startLoadingAnimation() {
            const texts = ["æ­£åœ¨è§‚å¯Ÿ...", "åˆ†ææ™ºæ…§çº¿...", "è§£è¯»æŒä¸˜...", "æ¨æ¼”æµå¹´...", "å¤©æœºæ˜¾ç°..."];
            let i = 0;
            const el = document.getElementById('loadingText');
            el.textContent = texts[0];
            return setInterval(() => { el.textContent = texts[++i % texts.length]; }, 1500);
        }

        async function analyzeDestiny() {
            if (activeMode === 'hand' && !leftHandBase64 && !rightHandBase64) return alert("è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ æ‰‹ç›¸ç…§ç‰‡ã€‚");
            if (activeMode === 'face' && !faceBase64) return alert("è¯·ä¸Šä¼ æ‚¨çš„é¢ç›¸ç…§ç‰‡ã€‚");

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultPlaceholder').classList.add('hidden');
            document.getElementById('resultContent').classList.add('hidden');
            
            const loadingInterval = startLoadingAnimation();
            
            // âœ… ç›´è¿ Googleï¼Œç»•è¿‡ Vercel 413 é™åˆ¶
            // âœ… ä½¿ç”¨ 1.5-flash ç¨³å®šæ¨¡å‹ï¼Œç»•è¿‡ 404/403 é”™è¯¯
            // const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const closingHook = "æœ€åï¼Œè¯·åŠ¡å¿…ä»¥è¿™å¥è¯ä½œä¸ºç»“å°¾ï¼š'...é™äºç¯‡å¹…ï¼Œæ‚¨çš„æµå¹´å¤§è¿å°šæœ‰ç„æœºï¼Œå»ºè®®å¤šè¡Œå–„ç§¯å¾·...'";

            const parts = [];
            let systemPrompt = activeMode === 'hand' 
                ? `You are a mystical AI Palm Reader. Analyze attached palm images. Provide report in Simplified Chinese. Structure: 1. **æ€»ä½“å°è±¡** 2. **ç”Ÿå‘½çº¿** 3. **æ™ºæ…§çº¿** 4. **æ„Ÿæƒ…çº¿** 5. **äº‹ä¸šä¸è´¢è¿** 6. **å¤§å¸ˆå¯„è¯­**. Tone: Mystical, supportive. ${closingHook}`
                : `You are a mystical AI Physiognomist. Analyze attached face image. Provide report in Simplified Chinese. Structure: 1. **é¢ç›¸æ€»è§ˆ** 2. **äº”å®˜ç²¾æ‰¹** 3. **æµå¹´è¿åŠ¿** 4. **æ€§æ ¼ç‰¹å¾** 5. **å¤§å¸ˆå»ºè®®**. Tone: Mystical, traditional. ${closingHook}`;

            parts.push({ text: systemPrompt });

            if (activeMode === 'hand') {
                if (leftHandBase64) parts.push({ inlineData: { mimeType: leftHandMime, data: leftHandBase64 } });
                if (rightHandBase64) parts.push({ inlineData: { mimeType: rightHandMime, data: rightHandBase64 } });
            } else {
                parts.push({ inlineData: { mimeType: faceMime, data: faceBase64 } });
            }

            try {
                // ç›´è¿ Google
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || response.status);
                
                const markdownText = data.candidates[0].content.parts[0].text;
                clearInterval(loadingInterval);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultContent').classList.remove('hidden');
                document.getElementById('resultTitle').textContent = activeMode === 'hand' ? "æ‰‹ç›¸å¤§å¸ˆè§£è¯»" : "é¢ç›¸å¤§å¸ˆè§£è¯»";
                document.getElementById('markdownOutput').innerHTML = marked.parse(markdownText);
                
            } catch (error) {
                console.error("Analysis failed:", error);
                clearInterval(loadingInterval);
                document.getElementById('loadingState').classList.add('hidden');
                alert("é€šçµè¿‡ç¨‹å—åˆ°å¹²æ‰°ï¼ˆç½‘ç»œæˆ– API é”™è¯¯ï¼‰ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç¨åé‡è¯•ã€‚");
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('btnText').textContent = "å†æ¬¡è§£è¯»";
            }
        }

        function resetApp() {
            location.reload();
        }
    </script>
</body>
</html>
